---
// ViewToggle.astro - Toggle between terminal and desktop views
// This component sits in the header and allows users to switch view modes
---

<button
  id="view-toggle"
  data-testid="view-toggle"
  class="view-toggle-btn"
  aria-label="Toggle between terminal and desktop view"
  title="Switch view"
>
  <span class="toggle-icon terminal-icon" aria-hidden="true">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="4 17 10 11 4 5"></polyline>
      <line x1="12" y1="19" x2="20" y2="19"></line>
    </svg>
  </span>
  <span class="toggle-icon desktop-icon hidden" aria-hidden="true">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
      <line x1="8" y1="21" x2="16" y2="21"></line>
      <line x1="12" y1="17" x2="12" y2="21"></line>
    </svg>
  </span>
  <span class="toggle-label ml-2">Desktop</span>
</button>

<style>
  .view-toggle-btn {
    display: flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border: 1px solid var(--term-fg-dark);
    border-radius: 0.375rem;
    background: transparent;
    color: var(--term-fg);
    font-family: inherit;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .view-toggle-btn:hover {
    border-color: var(--term-cyan);
    color: var(--term-cyan);
  }

  .view-toggle-btn:focus {
    outline: 2px solid var(--term-cyan);
    outline-offset: 2px;
  }

  .toggle-icon {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .hidden {
    display: none;
  }

  /* Mobile responsive */
  @media (max-width: 640px) {
    .toggle-label {
      display: none;
    }

    .view-toggle-btn {
      padding: 0.5rem;
    }
  }
</style>

<script>
  import { toggleView, getCurrentView, initViewToggle } from '@/scripts/view-toggle';

  // Initialize view toggle on page load
  function setupViewToggle() {
    const button = document.getElementById('view-toggle');
    if (!button) return;

    // Initialize view state
    initViewToggle();

    // Update button appearance based on current view
    updateButtonAppearance();

    // Handle click
    button.addEventListener('click', () => {
      toggleView();
      updateButtonAppearance();
    });

    // Handle keyboard shortcut (Ctrl+Shift+D)
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        e.preventDefault();
        toggleView();
        updateButtonAppearance();
      }
    });
  }

  function updateButtonAppearance() {
    const button = document.getElementById('view-toggle');
    const terminalIcon = button?.querySelector('.terminal-icon');
    const desktopIcon = button?.querySelector('.desktop-icon');
    const label = button?.querySelector('.toggle-label');

    if (!button || !terminalIcon || !desktopIcon || !label) return;

    const currentView = getCurrentView();

    if (currentView === 'desktop') {
      // Currently in desktop, show terminal icon to switch back
      terminalIcon.classList.remove('hidden');
      desktopIcon.classList.add('hidden');
      label.textContent = 'Terminal';
      button.setAttribute('title', 'Switch to Terminal view');
    } else {
      // Currently in terminal, show desktop icon to switch
      terminalIcon.classList.add('hidden');
      desktopIcon.classList.remove('hidden');
      label.textContent = 'Desktop';
      button.setAttribute('title', 'Switch to Desktop view');
    }
  }

  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupViewToggle);
  } else {
    setupViewToggle();
  }

  // Support Astro View Transitions
  document.addEventListener('astro:page-load', setupViewToggle);

  // Listen for view change events from other scripts
  document.addEventListener('view-changed', updateButtonAppearance as EventListener);
</script>
