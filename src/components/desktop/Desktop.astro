---
/**
 * Desktop.astro - Main desktop container component
 * Displays blog posts as icons in a grid layout (macOS-inspired)
 */
import { getCollection } from "astro:content";
import DesktopIcon from "./DesktopIcon.astro";

// Get all published posts
const posts = await getCollection("posts", ({ data }) => !data.draft);

// Sort by date (newest first)
const sortedPosts = posts.sort((a, b) =>
  new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
);
---

<div class="desktop-container">
  <!-- Desktop background -->
  <div class="desktop-background"></div>

  <!-- Windows container (dynamically populated) -->
  <div id="desktop-windows-container"></div>

  <!-- Icon grid for posts (no folders in Phase 1) -->
  <div class="desktop-icons-grid">
    {sortedPosts.map((post) => (
      <DesktopIcon
        title={post.data.title}
        slug={post.slug}
        type="file"
        coverImage={post.data.coverImage}
        pubDate={post.data.pubDate}
        tags={post.data.tags}
      />
    ))}
  </div>

  <!-- Message for mobile/small screens -->
  <div class="desktop-mobile-message">
    <div class="message-content">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
        <line x1="8" y1="21" x2="16" y2="21"></line>
        <line x1="12" y1="17" x2="12" y2="21"></line>
      </svg>
      <h2>Desktop View</h2>
      <p>Desktop view works best on larger screens (1024px+).</p>
      <p>Please switch to terminal view or use a desktop browser.</p>
    </div>
  </div>
</div>

<style>
  .desktop-container {
    position: relative;
    width: 100%;
    min-height: 100vh;
    overflow: hidden;
  }

  .desktop-background {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg,
      var(--desktop-bg-start, #1a1f2e) 0%,
      var(--desktop-bg-end, #2d3748) 100%
    );
    z-index: -1;
  }

  .desktop-icons-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 2rem;
    padding: 2rem;
    max-width: 100%;
    margin: 0 auto;
  }

  /* Mobile message - shown on small screens */
  .desktop-mobile-message {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.95);
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .message-content {
    text-align: center;
    padding: 2rem;
    color: var(--term-fg);
  }

  .message-content svg {
    margin: 0 auto 1rem;
    color: var(--term-cyan);
  }

  .message-content h2 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    color: var(--term-cyan);
  }

  .message-content p {
    margin-bottom: 0.5rem;
    color: var(--term-fg-dark);
  }

  /* Show mobile message on small screens */
  @media (max-width: 1023px) {
    .desktop-mobile-message {
      display: flex;
    }

    .desktop-icons-grid {
      display: none;
    }
  }

  /* Responsive grid for larger screens */
  @media (min-width: 1024px) {
    .desktop-icons-grid {
      grid-template-columns: repeat(auto-fill, minmax(100px, 100px));
      padding: 3rem;
    }
  }

  @media (min-width: 1440px) {
    .desktop-icons-grid {
      grid-template-columns: repeat(auto-fill, minmax(100px, 100px));
      padding: 4rem;
    }
  }

  /* View transition animations */
  :global(.view-exit) {
    animation: fadeOut 500ms ease-in-out forwards;
  }

  :global(.view-enter) {
    animation: fadeIn 500ms ease-in-out forwards;
  }

  @keyframes fadeOut {
    from {
      opacity: 1;
      transform: scale(1);
    }
    to {
      opacity: 0;
      transform: scale(0.98);
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(1.02);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  :global(.hidden) {
    display: none !important;
  }

  /* Windows container */
  #desktop-windows-container {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 100;
  }

  #desktop-windows-container > * {
    pointer-events: auto;
  }
</style>

<script>
  import { windowManager } from '@/scripts/desktop/window-manager';
  import type { WindowState } from '@/scripts/desktop/window-manager';

  // Listen for window open events from icons
  function setupDesktopWindowManager() {
    // Subscribe to window manager state changes
    windowManager.subscribe((state) => {
      renderWindows(state.windows);
    });

    // Listen for custom events to open windows
    document.addEventListener('desktop:open-post', ((event: CustomEvent) => {
      const { slug, title } = event.detail;
      openPostWindow(slug, title);
    }) as EventListener);
  }

  function openPostWindow(slug: string, title: string) {
    const windowState = windowManager.openWindow(slug, title);
    if (!windowState) return;

    // Render the window
    renderWindows(windowManager.getAllWindows());
  }

  function renderWindows(windows: WindowState[]) {
    const container = document.getElementById('desktop-windows-container');
    if (!container) return;

    // Clear and re-render all windows
    container.innerHTML = '';

    windows.forEach((window) => {
      const windowEl = createWindowElement(window);
      container.appendChild(windowEl);
    });

    // Re-initialize window scripts after rendering
    // Trigger a custom event that the window script can listen to
    const event = new CustomEvent('windows-rendered');
    document.dispatchEvent(event);
  }

  function createWindowElement(state: WindowState): HTMLElement {
    const div = document.createElement('div');
    div.className = 'desktop-window';
    div.setAttribute('data-window-id', state.id);
    div.setAttribute('data-post-slug', state.postSlug);
    div.style.cssText = `
      left: ${state.position.x}px;
      top: ${state.position.y}px;
      width: ${state.size.width}px;
      height: ${state.size.height}px;
      z-index: ${state.zIndex};
    `;

    div.innerHTML = `
      <div class="window-titlebar" data-draggable="true">
        <div class="traffic-lights">
          <button class="traffic-light traffic-light-close" aria-label="Close window" data-action="close">
            <svg width="12" height="12" viewBox="0 0 12 12">
              <line x1="3" y1="3" x2="9" y2="9" stroke="currentColor" stroke-width="1.5" />
              <line x1="9" y1="3" x2="3" y2="9" stroke="currentColor" stroke-width="1.5" />
            </svg>
          </button>
          <button class="traffic-light traffic-light-minimize" aria-label="Minimize window" data-action="minimize" disabled>
            <svg width="12" height="12" viewBox="0 0 12 12">
              <line x1="3" y1="6" x2="9" y2="6" stroke="currentColor" stroke-width="1.5" />
            </svg>
          </button>
          <button class="traffic-light traffic-light-maximize" aria-label="Maximize window" data-action="maximize" disabled>
            <svg width="12" height="12" viewBox="0 0 12 12">
              <polyline points="3,5 3,3 9,3 9,9 7,9" fill="none" stroke="currentColor" stroke-width="1.5" />
              <polyline points="5,7 5,9 9,9" fill="none" stroke="currentColor" stroke-width="1.5" />
            </svg>
          </button>
        </div>
        <div class="window-title">${escapeHtml(state.title)}</div>
        <div class="traffic-lights-spacer"></div>
      </div>
      <div class="window-content">
        <div class="window-loading">
          <div class="spinner"></div>
          <p>Loading post...</p>
        </div>
        <div class="window-post-content hidden"></div>
      </div>
    `;

    // Setup window interactions
    setupWindowInteractions(div, state.id);
    loadPostContent(div, state.postSlug);

    return div;
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function setupWindowInteractions(windowEl: HTMLElement, windowId: string) {
    // Close button
    const closeBtn = windowEl.querySelector('[data-action="close"]');
    closeBtn?.addEventListener('click', () => {
      windowEl.style.animation = 'windowClose 0.2s ease-in forwards';
      setTimeout(() => {
        windowManager.closeWindow(windowId);
      }, 200);
    });

    // Bring to front on click
    windowEl.addEventListener('mousedown', () => {
      windowManager.bringToFront(windowId);
    });

    // Setup dragging
    setupDragging(windowEl, windowId);
  }

  function setupDragging(windowEl: HTMLElement, windowId: string) {
    const titlebar = windowEl.querySelector('.window-titlebar');
    if (!titlebar) return;

    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let initialX = 0;
    let initialY = 0;

    titlebar.addEventListener('mousedown', (e: Event) => {
      const mouseEvent = e as MouseEvent;
      if ((mouseEvent.target as HTMLElement).closest('.traffic-light')) return;

      isDragging = true;
      startX = mouseEvent.clientX;
      startY = mouseEvent.clientY;

      const rect = windowEl.getBoundingClientRect();
      initialX = rect.left;
      initialY = rect.top;
    });

    const handleMouseMove = (e: MouseEvent) => {
      if (!isDragging) return;

      const deltaX = e.clientX - startX;
      const deltaY = e.clientY - startY;

      const newX = Math.max(0, Math.min(initialX + deltaX, window.innerWidth - windowEl.offsetWidth));
      const newY = Math.max(0, Math.min(initialY + deltaY, window.innerHeight - windowEl.offsetHeight));

      windowEl.style.left = `${newX}px`;
      windowEl.style.top = `${newY}px`;

      windowManager.updatePosition(windowId, { x: newX, y: newY });
    };

    const handleMouseUp = () => {
      isDragging = false;
    };

    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
  }

  async function loadPostContent(windowEl: HTMLElement, postSlug: string) {
    const contentEl = windowEl.querySelector('.window-post-content');
    const loadingEl = windowEl.querySelector('.window-loading');

    try {
      const response = await fetch(`/posts/${postSlug}`);
      if (!response.ok) throw new Error('Failed to load post');

      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const articleContent = doc.querySelector('article')?.innerHTML || doc.querySelector('main')?.innerHTML;

      if (contentEl && articleContent) {
        contentEl.innerHTML = articleContent;
        loadingEl?.classList.add('hidden');
        contentEl.classList.remove('hidden');
      }
    } catch (error) {
      console.error('Error loading post:', error);
      if (contentEl) {
        contentEl.innerHTML = '<p style="color: var(--term-red)">Failed to load post content.</p>';
        loadingEl?.classList.add('hidden');
        contentEl.classList.remove('hidden');
      }
    }
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupDesktopWindowManager);
  } else {
    setupDesktopWindowManager();
  }

  document.addEventListener('astro:page-load', setupDesktopWindowManager);
</script>
