---
/**
 * Desktop.astro - Main desktop container component
 * Displays blog posts as icons in a grid layout (macOS-inspired)
 * Phase 4: Added Dock component
 */
import { getCollection } from "astro:content";
import DesktopIcon from "./DesktopIcon.astro";
import Dock from "./Dock.astro";
import ContextMenu from "./ContextMenu.astro";
import type { Post } from "@/scripts/desktop/file-system";

// Get all published posts
const posts = await getCollection("posts", ({ data }) => !data.draft);

// Convert to Post format for file system
const postsData: Post[] = posts.map((post) => ({
  slug: post.slug,
  title: post.data.title,
  series: post.data.series,
  pubDate: new Date(post.data.pubDate),
  tags: post.data.tags,
  coverImage: post.data.cover,
}));
---

<div class="desktop-container">
  <!-- Desktop background -->
  <div class="desktop-background"></div>

  <!-- Windows container (dynamically populated) -->
  <div id="desktop-windows-container"></div>

  <!-- Icon grid for files and folders (dynamically rendered by script) -->
  <div class="desktop-icons-grid" id="desktop-icons-container">
    <!-- Icons will be rendered dynamically by the script -->
  </div>

  <!-- Folder view container (shown when opening a folder) -->
  <div id="desktop-folder-container" class="hidden">
    <!-- Folder view will be rendered dynamically by the script -->
  </div>

  <!-- Hidden posts data for script to use -->
  <script type="application/json" id="posts-data">
    {JSON.stringify(postsData)}
  </script>

  <!-- Message for mobile/small screens -->
  <div class="desktop-mobile-message">
    <div class="message-content">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
        <line x1="8" y1="21" x2="16" y2="21"></line>
        <line x1="12" y1="17" x2="12" y2="21"></line>
      </svg>
      <h2>Desktop View</h2>
      <p>Desktop view works best on larger screens (1024px+).</p>
      <p>Please switch to terminal view or use a desktop browser.</p>
    </div>
  </div>

  <!-- Dock - macOS-style navigation bar -->
  <Dock />

  <!-- Context Menu - Right-click menu for files and folders -->
  <ContextMenu />
</div>

<style>
  .desktop-container {
    position: relative;
    width: 100%;
    min-height: 100vh;
    overflow: hidden;
  }

  .desktop-background {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg,
      var(--desktop-bg-start, #1a1f2e) 0%,
      var(--desktop-bg-end, #2d3748) 100%
    );
    z-index: -1;
  }

  .desktop-icons-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 2rem;
    padding: 2rem;
    max-width: 100%;
    margin: 0 auto;
  }

  /* Mobile message - shown on small screens */
  .desktop-mobile-message {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.95);
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .message-content {
    text-align: center;
    padding: 2rem;
    color: var(--term-fg);
  }

  .message-content svg {
    margin: 0 auto 1rem;
    color: var(--term-cyan);
  }

  .message-content h2 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    color: var(--term-cyan);
  }

  .message-content p {
    margin-bottom: 0.5rem;
    color: var(--term-fg-dark);
  }

  /* Show mobile message on small screens */
  @media (max-width: 1023px) {
    .desktop-mobile-message {
      display: flex;
    }

    .desktop-icons-grid {
      display: none;
    }
  }

  /* Responsive grid for larger screens */
  @media (min-width: 1024px) {
    .desktop-icons-grid {
      grid-template-columns: repeat(auto-fill, minmax(100px, 100px));
      padding: 3rem;
    }
  }

  @media (min-width: 1440px) {
    .desktop-icons-grid {
      grid-template-columns: repeat(auto-fill, minmax(100px, 100px));
      padding: 4rem;
    }
  }

  /* View transition animations */
  :global(.view-exit) {
    animation: fadeOut 500ms ease-in-out forwards;
  }

  :global(.view-enter) {
    animation: fadeIn 500ms ease-in-out forwards;
  }

  @keyframes fadeOut {
    from {
      opacity: 1;
      transform: scale(1);
    }
    to {
      opacity: 0;
      transform: scale(0.98);
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(1.02);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  :global(.hidden) {
    display: none !important;
  }

  /* Windows container */
  #desktop-windows-container {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 100;
  }

  #desktop-windows-container > * {
    pointer-events: auto;
  }

  /* Folder view container */
  #desktop-folder-container {
    position: absolute;
    inset: 0;
    z-index: 10;
  }

  /* Folder view styles */
  :global(.folder-view) {
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg,
      var(--desktop-bg-start, #1a1f2e) 0%,
      var(--desktop-bg-end, #2d3748) 100%
    );
    overflow-y: auto;
    animation: folderSlideIn 0.3s ease-out forwards;
  }

  @keyframes folderSlideIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  :global(.folder-header) {
    position: sticky;
    top: 0;
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem 2rem;
    background: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 20;
  }

  :global(.back-button) {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
    color: var(--term-fg);
    font-family: 'Fira Code', monospace;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  :global(.back-button:hover) {
    background: rgba(255, 255, 255, 0.1);
    border-color: var(--term-cyan);
    color: var(--term-cyan);
  }

  :global(.back-button:active) {
    transform: scale(0.98);
  }

  :global(.folder-title) {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
    color: var(--term-yellow);
    font-family: 'Fira Code', monospace;
    font-size: 1.25rem;
    font-weight: 600;
  }

  :global(.folder-title svg) {
    color: var(--term-yellow);
    flex-shrink: 0;
  }

  :global(.folder-info) {
    color: var(--term-fg-dark);
    font-family: 'Fira Code', monospace;
    font-size: 0.875rem;
  }

  :global(.folder-contents) {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 100px));
    gap: 2rem;
    padding: 2rem 3rem;
  }

  @media (max-width: 1023px) {
    :global(.folder-contents) {
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      padding: 2rem;
    }

    :global(.folder-header) {
      padding: 1rem;
    }

    :global(.folder-title) {
      font-size: 1rem;
    }
  }
</style>

<script>
  import { windowManager } from '@/scripts/desktop/window-manager';
  import type { WindowState } from '@/scripts/desktop/window-manager';
  import { buildFileSystem, getItemsForPath, getParentPath, isRootPath, getBreadcrumb } from '@/scripts/desktop/file-system';
  import type { Post, FileSystem } from '@/scripts/desktop/file-system';

  // Desktop state
  let currentPath = '~';
  let fileSystem: FileSystem;

  // Listen for window open events from icons
  function setupDesktopWindowManager() {
    // Load posts data from script tag
    const postsDataEl = document.getElementById('posts-data');
    if (!postsDataEl) {
      console.error('Posts data not found');
      return;
    }

    try {
      const posts: Post[] = JSON.parse(postsDataEl.textContent || '[]');
      fileSystem = buildFileSystem(posts);

      // Initial render
      renderDesktop();
    } catch (error) {
      console.error('Failed to parse posts data:', error);
      return;
    }

    // Subscribe to window manager state changes
    windowManager.subscribe((state) => {
      renderWindows(state.windows);
    });

    // Listen for custom events to open windows
    document.addEventListener('desktop:open-post', ((event: CustomEvent) => {
      const { slug, title } = event.detail;
      openPostWindow(slug, title);
    }) as EventListener);

    // Listen for folder open events
    document.addEventListener('desktop:open-folder', ((event: CustomEvent) => {
      const { series, title } = event.detail;
      openFolder(series);
    }) as EventListener);

    // Listen for navigate back events
    document.addEventListener('desktop:navigate-back', (() => {
      navigateBack();
    }) as EventListener);

    // Listen for dock navigation events
    document.addEventListener('dock:navigate-home', (() => {
      navigateToRoot();
    }) as EventListener);

    // Listen for dock terminal switch event
    document.addEventListener('view:toggle-to-terminal', (() => {
      switchToTerminal();
    }) as EventListener);

    // Setup keyboard navigation
    setupKeyboardNavigation();
  }

  function renderDesktop() {
    const items = getItemsForPath(currentPath, fileSystem);
    const iconsContainer = document.getElementById('desktop-icons-container');
    const folderContainer = document.getElementById('desktop-folder-container');

    if (!iconsContainer || !folderContainer) return;

    if (isRootPath(currentPath)) {
      // Show icons grid, hide folder view
      iconsContainer.classList.remove('hidden');
      folderContainer.classList.add('hidden');
      renderIcons(items);
    } else {
      // Show folder view, hide icons grid
      iconsContainer.classList.add('hidden');
      folderContainer.classList.remove('hidden');
      renderFolderView();
    }
  }

  function renderIcons(items: any[]) {
    const container = document.getElementById('desktop-icons-container');
    if (!container) return;

    container.innerHTML = '';

    items.forEach((item) => {
      const iconEl = document.createElement('div');
      iconEl.className = 'desktop-icon';
      iconEl.setAttribute('data-type', item.type);
      iconEl.setAttribute('role', 'button');
      iconEl.setAttribute('tabindex', '0');
      iconEl.setAttribute('aria-label', `${item.type === 'file' ? 'Post' : 'Folder'}: ${item.name}`);

      if (item.type === 'file') {
        iconEl.setAttribute('data-post', item.slug || '');
      } else {
        iconEl.setAttribute('data-folder', item.series || '');
      }

      const displayTitle = item.name.length > 20 ? item.name.substring(0, 17) + '...' : item.name;

      iconEl.innerHTML = `
        <div class="icon-visual">
          ${item.type === 'file' ? `
            <div class="file-icon">
              ${item.coverImage ? `
                <img src="${item.coverImage}" alt="" class="icon-preview" />
              ` : `
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
              `}
              <div class="file-extension">.md</div>
            </div>
          ` : `
            <div class="folder-icon">
              <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
              </svg>
            </div>
          `}
        </div>
        <div class="icon-label">${displayTitle}</div>
        ${item.type === 'folder' && item.postCount ? `
          <div class="folder-metadata">${item.postCount} ${item.postCount === 1 ? 'post' : 'posts'}</div>
        ` : ''}
        ${item.tags && item.tags.length > 0 ? `
          <div class="icon-metadata">
            ${item.tags.slice(0, 3).map((tag: string, idx: number) => `
              <span class="tag-dot" title="${tag}"></span>
            `).join('')}
          </div>
        ` : ''}
      `;

      container.appendChild(iconEl);
    });

    // Re-setup icon interactions after rendering
    setupIconInteractions();
  }

  function renderFolderView() {
    const container = document.getElementById('desktop-folder-container');
    if (!container) return;

    // Extract series name from path
    const match = currentPath.match(/^~\/series\/(.+)$/);
    if (!match) return;

    const seriesName = decodeURIComponent(match[1]);
    const folder = fileSystem.folders.find((f) => f.series === seriesName);

    if (!folder || !folder.posts) return;

    container.innerHTML = `
      <div class="folder-view">
        <div class="folder-header">
          <button class="back-button" aria-label="Back to desktop">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="19" y1="12" x2="5" y2="12"></line>
              <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            <span>Back</span>
          </button>

          <div class="folder-title">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
            <span>${folder.name}</span>
          </div>

          <div class="folder-info">
            ${folder.posts.length} ${folder.posts.length === 1 ? 'post' : 'posts'}
          </div>
        </div>

        <div class="folder-contents" id="folder-contents-grid">
          <!-- Posts will be rendered here -->
        </div>
      </div>
    `;

    // Render posts in folder
    const postsContainer = container.querySelector('#folder-contents-grid');
    if (postsContainer) {
      folder.posts.forEach((post) => {
        const iconEl = document.createElement('div');
        iconEl.className = 'desktop-icon';
        iconEl.setAttribute('data-type', 'file');
        iconEl.setAttribute('data-post', post.slug);
        iconEl.setAttribute('role', 'button');
        iconEl.setAttribute('tabindex', '0');
        iconEl.setAttribute('aria-label', `Post: ${post.title}`);

        const displayTitle = post.title.length > 20 ? post.title.substring(0, 17) + '...' : post.title;

        iconEl.innerHTML = `
          <div class="icon-visual">
            <div class="file-icon">
              ${post.coverImage ? `
                <img src="${post.coverImage}" alt="" class="icon-preview" />
              ` : `
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
              `}
              <div class="file-extension">.md</div>
            </div>
          </div>
          <div class="icon-label">${displayTitle}</div>
        `;

        postsContainer.appendChild(iconEl);
      });
    }

    // Setup back button
    const backButton = container.querySelector('.back-button');
    if (backButton) {
      backButton.addEventListener('click', () => {
        navigateBack();
      });
    }

    // Setup icon interactions in folder
    setupIconInteractions();
  }

  function setupIconInteractions() {
    const icons = document.querySelectorAll('.desktop-icon');

    icons.forEach((icon) => {
      // Remove old listeners by cloning
      const newIcon = icon.cloneNode(true) as HTMLElement;
      icon.parentNode?.replaceChild(newIcon, icon);

      // Double-click handler
      newIcon.addEventListener('dblclick', () => {
        const type = newIcon.getAttribute('data-type');
        const slug = newIcon.getAttribute(type === 'file' ? 'data-post' : 'data-folder');

        if (type === 'file' && slug) {
          const title = newIcon.querySelector('.icon-label')?.textContent?.trim() || 'Untitled';
          const event = new CustomEvent('desktop:open-post', {
            detail: { slug, title },
            bubbles: true,
          });
          document.dispatchEvent(event);
        } else if (type === 'folder' && slug) {
          const event = new CustomEvent('desktop:open-folder', {
            detail: { series: slug, title: newIcon.querySelector('.icon-label')?.textContent?.trim() },
            bubbles: true,
          });
          document.dispatchEvent(event);
        }
      });

      // Single-click to select
      newIcon.addEventListener('click', (e) => {
        if (!e.ctrlKey && !e.metaKey) {
          document.querySelectorAll('.desktop-icon.selected').forEach((selected) => {
            selected.classList.remove('selected');
          });
        }
        newIcon.classList.toggle('selected');
      });

      // Keyboard support
      newIcon.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          newIcon.dispatchEvent(new Event('dblclick'));
        }
      });
    });
  }

  function openFolder(series: string) {
    currentPath = `~/series/${encodeURIComponent(series)}`;
    renderDesktop();
  }

  function navigateBack() {
    currentPath = getParentPath(currentPath);
    renderDesktop();
  }

  function navigateToRoot() {
    currentPath = '~';
    renderDesktop();
  }

  function switchToTerminal() {
    // Dispatch the same event that ViewToggle uses
    const event = new CustomEvent('view:toggle');
    document.dispatchEvent(event);
  }

  function setupKeyboardNavigation() {
    let selectedIndex = -1;

    document.addEventListener('keydown', (e) => {
      // Only handle keyboard when desktop is visible and not in a window or context menu
      const desktopVisible = !document.querySelector('.terminal-view-container:not(.view-exit)');
      const contextMenuVisible = !document.getElementById('context-menu')?.classList.contains('hidden');
      const windowFocused = document.activeElement?.closest('.desktop-window');

      if (!desktopVisible || contextMenuVisible || windowFocused) return;

      const icons = Array.from(document.querySelectorAll('.desktop-icon'));
      if (icons.length === 0) return;

      switch (e.key) {
        case 'ArrowRight':
          e.preventDefault();
          selectedIndex = (selectedIndex + 1) % icons.length;
          selectIcon(icons, selectedIndex);
          break;

        case 'ArrowLeft':
          e.preventDefault();
          selectedIndex = selectedIndex <= 0 ? icons.length - 1 : selectedIndex - 1;
          selectIcon(icons, selectedIndex);
          break;

        case 'ArrowDown':
          e.preventDefault();
          // Move down in grid (approximate 8 items per row)
          const itemsPerRow = Math.floor(window.innerWidth / 140) || 8;
          selectedIndex = Math.min(selectedIndex + itemsPerRow, icons.length - 1);
          selectIcon(icons, selectedIndex);
          break;

        case 'ArrowUp':
          e.preventDefault();
          // Move up in grid
          const itemsPerRowUp = Math.floor(window.innerWidth / 140) || 8;
          selectedIndex = Math.max(selectedIndex - itemsPerRowUp, 0);
          selectIcon(icons, selectedIndex);
          break;

        case 'Enter':
        case ' ':
          e.preventDefault();
          if (selectedIndex >= 0 && selectedIndex < icons.length) {
            const icon = icons[selectedIndex] as HTMLElement;
            icon.dispatchEvent(new Event('dblclick'));
          }
          break;

        case 'Backspace':
          e.preventDefault();
          if (!isRootPath(currentPath)) {
            navigateBack();
            selectedIndex = -1;
          }
          break;

        case 'Escape':
          e.preventDefault();
          // Deselect all
          icons.forEach((icon) => icon.classList.remove('selected'));
          selectedIndex = -1;
          break;
      }
    });
  }

  function selectIcon(icons: Element[], index: number) {
    // Clear previous selection
    icons.forEach((icon) => icon.classList.remove('selected'));

    // Select new icon
    if (index >= 0 && index < icons.length) {
      const icon = icons[index] as HTMLElement;
      icon.classList.add('selected');
      icon.focus({ preventScroll: false });

      // Scroll into view if needed
      icon.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }

  function openPostWindow(slug: string, title: string) {
    const windowState = windowManager.openWindow(slug, title);
    if (!windowState) return;

    // Render the window
    renderWindows(windowManager.getAllWindows());
  }

  function renderWindows(windows: WindowState[]) {
    const container = document.getElementById('desktop-windows-container');
    if (!container) return;

    // Clear and re-render all windows
    container.innerHTML = '';

    windows.forEach((window) => {
      const windowEl = createWindowElement(window);
      container.appendChild(windowEl);
    });

    // Re-initialize window scripts after rendering
    // Trigger a custom event that the window script can listen to
    const event = new CustomEvent('windows-rendered');
    document.dispatchEvent(event);
  }

  function createWindowElement(state: WindowState): HTMLElement {
    const div = document.createElement('div');
    div.className = 'desktop-window';
    div.setAttribute('data-window-id', state.id);
    div.setAttribute('data-post-slug', state.postSlug);
    div.style.cssText = `
      left: ${state.position.x}px;
      top: ${state.position.y}px;
      width: ${state.size.width}px;
      height: ${state.size.height}px;
      z-index: ${state.zIndex};
    `;

    div.innerHTML = `
      <div class="window-titlebar" data-draggable="true">
        <div class="traffic-lights">
          <button class="traffic-light traffic-light-close" aria-label="Close window" data-action="close">
            <svg width="12" height="12" viewBox="0 0 12 12">
              <line x1="3" y1="3" x2="9" y2="9" stroke="currentColor" stroke-width="1.5" />
              <line x1="9" y1="3" x2="3" y2="9" stroke="currentColor" stroke-width="1.5" />
            </svg>
          </button>
          <button class="traffic-light traffic-light-minimize" aria-label="Minimize window" data-action="minimize" disabled>
            <svg width="12" height="12" viewBox="0 0 12 12">
              <line x1="3" y1="6" x2="9" y2="6" stroke="currentColor" stroke-width="1.5" />
            </svg>
          </button>
          <button class="traffic-light traffic-light-maximize" aria-label="Maximize window" data-action="maximize" disabled>
            <svg width="12" height="12" viewBox="0 0 12 12">
              <polyline points="3,5 3,3 9,3 9,9 7,9" fill="none" stroke="currentColor" stroke-width="1.5" />
              <polyline points="5,7 5,9 9,9" fill="none" stroke="currentColor" stroke-width="1.5" />
            </svg>
          </button>
        </div>
        <div class="window-title">${escapeHtml(state.title)}</div>
        <div class="traffic-lights-spacer"></div>
      </div>
      <div class="window-content">
        <div class="window-loading">
          <div class="spinner"></div>
          <p>Loading post...</p>
        </div>
        <div class="window-post-content hidden"></div>
      </div>
    `;

    // Setup window interactions
    setupWindowInteractions(div, state.id);
    loadPostContent(div, state.postSlug);

    return div;
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function setupWindowInteractions(windowEl: HTMLElement, windowId: string) {
    // Close button
    const closeBtn = windowEl.querySelector('[data-action="close"]');
    closeBtn?.addEventListener('click', () => {
      windowEl.style.animation = 'windowClose 0.2s ease-in forwards';
      setTimeout(() => {
        windowManager.closeWindow(windowId);
      }, 200);
    });

    // Bring to front on click
    windowEl.addEventListener('mousedown', () => {
      windowManager.bringToFront(windowId);
    });

    // Setup dragging
    setupDragging(windowEl, windowId);
  }

  function setupDragging(windowEl: HTMLElement, windowId: string) {
    const titlebar = windowEl.querySelector('.window-titlebar');
    if (!titlebar) return;

    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let initialX = 0;
    let initialY = 0;

    titlebar.addEventListener('mousedown', (e: Event) => {
      const mouseEvent = e as MouseEvent;
      if ((mouseEvent.target as HTMLElement).closest('.traffic-light')) return;

      isDragging = true;
      startX = mouseEvent.clientX;
      startY = mouseEvent.clientY;

      const rect = windowEl.getBoundingClientRect();
      initialX = rect.left;
      initialY = rect.top;
    });

    const handleMouseMove = (e: MouseEvent) => {
      if (!isDragging) return;

      const deltaX = e.clientX - startX;
      const deltaY = e.clientY - startY;

      const newX = Math.max(0, Math.min(initialX + deltaX, window.innerWidth - windowEl.offsetWidth));
      const newY = Math.max(0, Math.min(initialY + deltaY, window.innerHeight - windowEl.offsetHeight));

      windowEl.style.left = `${newX}px`;
      windowEl.style.top = `${newY}px`;

      windowManager.updatePosition(windowId, { x: newX, y: newY });
    };

    const handleMouseUp = () => {
      isDragging = false;
    };

    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
  }

  async function loadPostContent(windowEl: HTMLElement, postSlug: string) {
    const contentEl = windowEl.querySelector('.window-post-content');
    const loadingEl = windowEl.querySelector('.window-loading');

    try {
      const response = await fetch(`/posts/${postSlug}`);
      if (!response.ok) throw new Error('Failed to load post');

      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const articleContent = doc.querySelector('article')?.innerHTML || doc.querySelector('main')?.innerHTML;

      if (contentEl && articleContent) {
        contentEl.innerHTML = articleContent;
        loadingEl?.classList.add('hidden');
        contentEl.classList.remove('hidden');
      }
    } catch (error) {
      console.error('Error loading post:', error);
      if (contentEl) {
        contentEl.innerHTML = '<p style="color: var(--term-red)">Failed to load post content.</p>';
        loadingEl?.classList.add('hidden');
        contentEl.classList.remove('hidden');
      }
    }
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupDesktopWindowManager);
  } else {
    setupDesktopWindowManager();
  }

  document.addEventListener('astro:page-load', setupDesktopWindowManager);
</script>
