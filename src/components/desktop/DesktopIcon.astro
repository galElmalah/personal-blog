---
/**
 * DesktopIcon.astro - Represents a file or folder on the desktop
 * Phase 1: Only files (posts), folders come in Phase 3
 */

interface Props {
  title: string;
  slug: string;
  type: 'file' | 'folder';
  coverImage?: string;
  pubDate?: Date;
  tags?: string[];
  postCount?: number; // For folders - number of posts in series
  series?: string; // For folders - series name
}

const { title, slug, type, coverImage, pubDate, tags, postCount, series } = Astro.props;

// Truncate title if too long
const displayTitle = title.length > 20 ? title.substring(0, 17) + '...' : title;
---

<div
  class="desktop-icon"
  data-post={type === 'file' ? slug : undefined}
  data-folder={type === 'folder' ? slug : undefined}
  data-type={type}
  role="button"
  tabindex="0"
  aria-label={`${type === 'file' ? 'Post' : 'Folder'}: ${title}`}
>
  <!-- Icon visual -->
  <div class="icon-visual">
    {type === 'file' ? (
      <div class="file-icon">
        {coverImage ? (
          <img src={coverImage} alt="" class="icon-preview" />
        ) : (
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
        )}
        <div class="file-extension">.md</div>
      </div>
    ) : (
      <div class="folder-icon">
        <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
        </svg>
      </div>
    )}
  </div>

  <!-- Icon label -->
  <div class="icon-label">
    {displayTitle}
  </div>

  <!-- Folder metadata (post count) -->
  {type === 'folder' && postCount && (
    <div class="folder-metadata">
      {postCount} {postCount === 1 ? 'post' : 'posts'}
    </div>
  )}

  <!-- Metadata badges (tags as colored dots) -->
  {tags && tags.length > 0 && (
    <div class="icon-metadata">
      {tags.slice(0, 3).map((tag) => (
        <span class="tag-dot" title={tag}></span>
      ))}
    </div>
  )}
</div>

<style>
  .desktop-icon {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.75rem 0.5rem;
    border-radius: 0.5rem;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.15s ease;
    position: relative;
  }

  .desktop-icon:hover {
    background-color: rgba(255, 255, 255, 0.05);
  }

  .desktop-icon:focus {
    outline: 2px solid var(--term-cyan);
    outline-offset: 2px;
  }

  .desktop-icon.selected {
    background-color: rgba(59, 130, 246, 0.2);
  }

  /* Icon visual container */
  .icon-visual {
    width: 64px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.5rem;
    position: relative;
  }

  /* File icon styling */
  .file-icon {
    position: relative;
    color: var(--term-fg);
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
  }

  .icon-preview {
    width: 48px;
    height: 48px;
    object-fit: cover;
    border-radius: 0.25rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .file-extension {
    position: absolute;
    bottom: -8px;
    right: -8px;
    background: var(--term-bg);
    color: var(--term-cyan);
    font-size: 0.625rem;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    border: 1px solid var(--term-cyan);
    font-family: 'Fira Code', monospace;
  }

  /* Folder icon styling */
  .folder-icon {
    color: var(--term-yellow);
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
  }

  /* Icon label */
  .icon-label {
    font-size: 0.75rem;
    color: var(--term-fg);
    text-align: center;
    max-width: 100%;
    word-break: break-word;
    line-height: 1.2;
    font-family: 'Fira Code', monospace;
  }

  /* Folder metadata */
  .folder-metadata {
    font-size: 0.625rem;
    color: var(--term-fg-dark);
    text-align: center;
    margin-top: 0.25rem;
    font-family: 'Fira Code', monospace;
  }

  /* Metadata badges */
  .icon-metadata {
    display: flex;
    gap: 0.25rem;
    margin-top: 0.25rem;
  }

  .tag-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--term-green);
    opacity: 0.7;
  }

  .tag-dot:nth-child(2) {
    background: var(--term-cyan);
  }

  .tag-dot:nth-child(3) {
    background: var(--term-yellow);
  }

  /* Hover effect */
  .desktop-icon:hover .icon-visual {
    transform: scale(1.05);
    transition: transform 0.2s ease;
  }
</style>

<script>
  // Handle double-click to open (will be implemented in Phase 2)
  function setupIconInteractions() {
    const icons = document.querySelectorAll('.desktop-icon');

    icons.forEach((icon) => {
      // Double-click handler - open window for posts or folders
      icon.addEventListener('dblclick', () => {
        const type = icon.getAttribute('data-type');
        const slug = icon.getAttribute(type === 'file' ? 'data-post' : 'data-folder');

        if (type === 'file' && slug) {
          // Get title from icon label
          const title = icon.querySelector('.icon-label')?.textContent?.trim() || 'Untitled';

          // Dispatch custom event to open post window
          const event = new CustomEvent('desktop:open-post', {
            detail: { slug, title },
            bubbles: true,
          });
          document.dispatchEvent(event);
        } else if (type === 'folder' && slug) {
          // Dispatch custom event to open folder
          const title = icon.querySelector('.icon-label')?.textContent?.trim() || 'Untitled';
          const event = new CustomEvent('desktop:open-folder', {
            detail: { series: slug, title },
            bubbles: true,
          });
          document.dispatchEvent(event);
        }
      });

      // Single-click to select
      icon.addEventListener('click', (e) => {
        // Clear other selections unless Ctrl/Cmd is held
        if (!e.ctrlKey && !e.metaKey) {
          document.querySelectorAll('.desktop-icon.selected').forEach((selected) => {
            selected.classList.remove('selected');
          });
        }

        icon.classList.toggle('selected');
      });

      // Keyboard support
      icon.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          icon.dispatchEvent(new Event('dblclick'));
        }
      });
    });
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupIconInteractions);
  } else {
    setupIconInteractions();
  }

  // Support Astro View Transitions
  document.addEventListener('astro:page-load', setupIconInteractions);
</script>
