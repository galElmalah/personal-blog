---
/**
 * DesktopIcon.astro - Represents a file or folder on the desktop
 * Phase 1: Only files (posts), folders come in Phase 3
 */

interface Props {
  title: string;
  slug: string;
  type: 'file' | 'folder';
  coverImage?: string;
  pubDate?: Date;
  tags?: string[];
  postCount?: number; // For folders - number of posts in series
  series?: string; // For folders - series name
}

const { title, slug, type, coverImage, pubDate, tags, postCount, series } = Astro.props;

// Truncate title if too long
const displayTitle = title.length > 20 ? title.substring(0, 17) + '...' : title;
---

<div
  class="desktop-icon"
  data-post={type === 'file' ? slug : undefined}
  data-folder={type === 'folder' ? slug : undefined}
  data-type={type}
  role="button"
  tabindex="0"
  aria-label={`${type === 'file' ? 'Post' : 'Folder'}: ${title}`}
>
  <!-- Icon visual -->
  <div class="icon-visual">
    {type === 'file' ? (
      <div class="file-icon">
        <div class="file-body">
          {coverImage ? (
            <img src={coverImage} alt="" class="icon-preview" />
          ) : (
            <div class="file-lines">
              <div class="line"></div>
              <div class="line"></div>
              <div class="line"></div>
              <div class="line"></div>
            </div>
          )}
        </div>
        <div class="file-corner"></div>
        <div class="file-extension">.md</div>
      </div>
    ) : (
      <div class="folder-icon">
        <div class="folder-body"></div>
        <div class="folder-tab"></div>
      </div>
    )}
  </div>

  <!-- Icon label -->
  <div class="icon-label">
    {displayTitle}
  </div>

  <!-- Folder metadata (post count) -->
  {type === 'folder' && postCount && (
    <div class="folder-metadata">
      {postCount} {postCount === 1 ? 'post' : 'posts'}
    </div>
  )}

  <!-- Metadata badges (tags as colored dots) -->
  {tags && tags.length > 0 && (
    <div class="icon-metadata">
      {tags.slice(0, 3).map((tag) => (
        <span class="tag-dot" title={tag}></span>
      ))}
    </div>
  )}
</div>

<style>
  .desktop-icon {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
    user-select: none;
    transition: all 0.15s ease;
    position: relative;
  }

  .desktop-icon:hover {
    background-color: rgba(255, 255, 255, 0.2);
  }

  .desktop-icon:focus {
    outline: 2px solid rgba(0, 122, 255, 0.8);
    outline-offset: 2px;
  }

  .desktop-icon.selected {
    background-color: rgba(0, 122, 255, 0.25);
  }

  /* Icon visual container */
  .icon-visual {
    width: 64px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  /* File icon styling - defined in desktop.css */
  .file-icon {
    position: relative;
  }

  .icon-preview {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 4px;
  }

  /* Folder icon styling - defined in desktop.css */
  .folder-icon {
    position: relative;
    width: 64px;
    height: 52px;
  }

  /* Icon label */
  .icon-label {
    font-size: 11px;
    color: #ffffff;
    text-align: center;
    max-width: 80px;
    word-break: break-word;
    line-height: 1.3;
    font-family: var(--font-primary);
    font-weight: 500;
    margin-top: 6px;
    text-shadow: 
      0 1px 2px rgba(0, 0, 0, 0.8),
      0 0 8px rgba(0, 0, 0, 0.5);
    padding: 2px 6px;
    border-radius: 4px;
  }

  /* Folder metadata */
  .folder-metadata {
    font-size: 10px;
    color: rgba(255, 255, 255, 0.9);
    text-align: center;
    margin-top: 2px;
    font-family: var(--font-primary);
    text-shadow: 
      0 1px 2px rgba(0, 0, 0, 0.8),
      0 0 6px rgba(0, 0, 0, 0.5);
  }

  /* Metadata badges */
  .icon-metadata {
    display: flex;
    gap: 3px;
    margin-top: 4px;
  }

  .tag-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #FF3B30;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
  }

  .tag-dot:nth-child(2) {
    background: #34C759;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
  }

  .tag-dot:nth-child(3) {
    background: #FF9500;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
  }

  /* Hover effect */
  .desktop-icon:hover .icon-visual {
    transform: scale(1.05);
    transition: transform 0.15s ease;
  }
</style>

<script>
  // Handle double-click to open (will be implemented in Phase 2)
  function setupIconInteractions() {
    const icons = document.querySelectorAll('.desktop-icon');

    icons.forEach((icon) => {
      // Double-click handler - open window for posts or folders
      icon.addEventListener('dblclick', () => {
        const type = icon.getAttribute('data-type');
        const slug = icon.getAttribute(type === 'file' ? 'data-post' : 'data-folder');

        if (type === 'file' && slug) {
          // Get title from icon label
          const title = icon.querySelector('.icon-label')?.textContent?.trim() || 'Untitled';

          // Dispatch custom event to open post window
          const event = new CustomEvent('desktop:open-post', {
            detail: { slug, title },
            bubbles: true,
          });
          document.dispatchEvent(event);
        } else if (type === 'folder' && slug) {
          // Dispatch custom event to open folder
          const title = icon.querySelector('.icon-label')?.textContent?.trim() || 'Untitled';
          const event = new CustomEvent('desktop:open-folder', {
            detail: { series: slug, title },
            bubbles: true,
          });
          document.dispatchEvent(event);
        }
      });

      // Single-click to select
      icon.addEventListener('click', (e) => {
        // Clear other selections unless Ctrl/Cmd is held
        if (!e.ctrlKey && !e.metaKey) {
          document.querySelectorAll('.desktop-icon.selected').forEach((selected) => {
            selected.classList.remove('selected');
          });
        }

        icon.classList.toggle('selected');
      });

      // Keyboard support
      icon.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          icon.dispatchEvent(new Event('dblclick'));
        }
      });
    });
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupIconInteractions);
  } else {
    setupIconInteractions();
  }

  // Support Astro View Transitions
  document.addEventListener('astro:page-load', setupIconInteractions);
</script>
