---
/**
 * Dock.astro - macOS-style dock component
 * Authentic macOS Sonoma dock with magnification effect
 */
---

<div class="dock-container">
  <div class="dock">
    <!-- Finder Icon -->
    <button
      class="dock-icon"
      data-action="home"
      aria-label="Finder - Return to desktop root"
      title="Finder"
    >
      <div class="dock-icon-wrapper">
        <svg viewBox="0 0 48 48" class="app-icon finder-icon">
          <defs>
            <linearGradient id="finderGrad" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style="stop-color:#6FD3FF"/>
              <stop offset="100%" style="stop-color:#0066CC"/>
            </linearGradient>
          </defs>
          <rect x="2" y="2" width="44" height="44" rx="10" fill="url(#finderGrad)"/>
          <!-- Finder face -->
          <ellipse cx="24" cy="26" rx="14" ry="12" fill="#fff"/>
          <!-- Eyes -->
          <circle cx="18" cy="24" r="3" fill="#000"/>
          <circle cx="30" cy="24" r="3" fill="#000"/>
          <!-- Smile -->
          <path d="M16 30 Q24 36 32 30" stroke="#000" stroke-width="2" fill="none"/>
          <!-- Nose line -->
          <line x1="24" y1="18" x2="24" y2="28" stroke="#000" stroke-width="2"/>
        </svg>
      </div>
      <span class="dock-icon-label">Finder</span>
    </button>

    <!-- Safari/Browser Icon -->
    <button
      class="dock-icon"
      data-action="posts"
      aria-label="Posts - View all posts"
      title="Posts"
    >
      <div class="dock-icon-wrapper">
        <svg viewBox="0 0 48 48" class="app-icon safari-icon">
          <defs>
            <linearGradient id="safariGrad" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style="stop-color:#19B3FF"/>
              <stop offset="100%" style="stop-color:#0066FF"/>
            </linearGradient>
          </defs>
          <rect x="2" y="2" width="44" height="44" rx="10" fill="url(#safariGrad)"/>
          <!-- Compass circle -->
          <circle cx="24" cy="24" r="16" fill="none" stroke="#fff" stroke-width="1.5"/>
          <!-- Compass needle -->
          <polygon points="24,8 27,24 24,28 21,24" fill="#FF3B30"/>
          <polygon points="24,40 21,24 24,20 27,24" fill="#fff"/>
          <!-- Direction markers -->
          <text x="24" y="9" fill="#fff" font-size="5" text-anchor="middle" font-weight="bold">N</text>
        </svg>
      </div>
      <span class="dock-icon-label">Posts</span>
    </button>

    <!-- Notes/Folder Icon -->
    <button
      class="dock-icon"
      data-action="series"
      aria-label="Series - View all series"
      title="Series"
    >
      <div class="dock-icon-wrapper">
        <svg viewBox="0 0 48 48" class="app-icon notes-icon">
          <defs>
            <linearGradient id="notesGrad" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style="stop-color:#FFE066"/>
              <stop offset="100%" style="stop-color:#FFA500"/>
            </linearGradient>
          </defs>
          <rect x="2" y="2" width="44" height="44" rx="10" fill="url(#notesGrad)"/>
          <!-- Folder body -->
          <rect x="8" y="16" width="32" height="24" rx="3" fill="#fff"/>
          <!-- Folder tab -->
          <path d="M8 16 L8 14 Q8 11 11 11 L18 11 L21 16 Z" fill="#fff"/>
          <!-- Lines -->
          <line x1="13" y1="23" x2="35" y2="23" stroke="#DDD" stroke-width="1.5"/>
          <line x1="13" y1="28" x2="35" y2="28" stroke="#DDD" stroke-width="1.5"/>
          <line x1="13" y1="33" x2="28" y2="33" stroke="#DDD" stroke-width="1.5"/>
        </svg>
      </div>
      <span class="dock-icon-label">Series</span>
    </button>

    <div class="dock-separator"></div>

    <!-- Terminal Icon -->
    <button
      class="dock-icon"
      data-action="terminal"
      aria-label="Terminal - Switch to terminal view"
      title="Terminal"
    >
      <div class="dock-icon-wrapper">
        <svg viewBox="0 0 48 48" class="app-icon terminal-icon">
          <defs>
            <linearGradient id="termGrad" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style="stop-color:#434343"/>
              <stop offset="100%" style="stop-color:#1a1a1a"/>
            </linearGradient>
          </defs>
          <rect x="2" y="2" width="44" height="44" rx="10" fill="url(#termGrad)"/>
          <!-- Terminal window -->
          <rect x="6" y="8" width="36" height="32" rx="4" fill="#1a1a1a" stroke="#3a3a3a" stroke-width="1"/>
          <!-- Title bar dots -->
          <circle cx="11" cy="13" r="2" fill="#FF5F56"/>
          <circle cx="17" cy="13" r="2" fill="#FFBD2E"/>
          <circle cx="23" cy="13" r="2" fill="#27C93F"/>
          <!-- Command prompt -->
          <text x="10" y="27" fill="#27C93F" font-size="8" font-family="monospace">$</text>
          <rect x="16" y="22" width="20" height="2" fill="#fff" opacity="0.8"/>
          <text x="10" y="35" fill="#27C93F" font-size="8" font-family="monospace">$</text>
          <rect x="16" y="30" width="8" height="8" fill="#27C93F" class="cursor-blink"/>
        </svg>
      </div>
      <span class="dock-icon-label">Terminal</span>
    </button>

    <div class="dock-separator"></div>

    <!-- Trash Icon -->
    <button
      class="dock-icon"
      data-action="none"
      aria-label="Trash"
      title="Trash"
    >
      <div class="dock-icon-wrapper">
        <svg viewBox="0 0 48 48" class="app-icon trash-icon">
          <defs>
            <linearGradient id="trashGrad" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style="stop-color:#8E8E93"/>
              <stop offset="100%" style="stop-color:#636366"/>
            </linearGradient>
          </defs>
          <rect x="2" y="2" width="44" height="44" rx="10" fill="url(#trashGrad)"/>
          <!-- Trash can body -->
          <path d="M14 16 L16 40 Q16 42 18 42 L30 42 Q32 42 32 40 L34 16 Z" fill="#fff" stroke="#D1D1D6" stroke-width="0.5"/>
          <!-- Trash can lid -->
          <rect x="12" y="12" width="24" height="4" rx="1" fill="#fff"/>
          <!-- Handle -->
          <rect x="20" y="9" width="8" height="4" rx="1" fill="#fff"/>
          <!-- Ribs -->
          <line x1="20" y1="20" x2="19" y2="38" stroke="#D1D1D6" stroke-width="1"/>
          <line x1="24" y1="20" x2="24" y2="38" stroke="#D1D1D6" stroke-width="1"/>
          <line x1="28" y1="20" x2="29" y2="38" stroke="#D1D1D6" stroke-width="1"/>
        </svg>
      </div>
      <span class="dock-icon-label">Trash</span>
    </button>
  </div>
</div>

<style>
  .dock-container {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    padding: 8px;
    pointer-events: none;
    z-index: 1000;
  }

  .dock {
    display: flex;
    align-items: flex-end;
    gap: 4px;
    padding: 4px 8px;
    background: rgba(255, 255, 255, 0.75);
    backdrop-filter: saturate(180%) blur(20px);
    -webkit-backdrop-filter: saturate(180%) blur(20px);
    border-radius: 18px;
    box-shadow: 
      0 0 0 0.5px rgba(0, 0, 0, 0.1),
      0 8px 32px rgba(0, 0, 0, 0.15);
    pointer-events: auto;
  }

  .dock-icon {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0;
    transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .dock-icon-wrapper {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .app-icon {
    width: 100%;
    height: 100%;
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
    transition: filter 0.15s ease;
  }

  .dock-icon-label {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(-12px);
    background: rgba(50, 50, 55, 0.95);
    color: rgba(255, 255, 255, 0.95);
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-family: var(--font-primary);
    font-weight: 500;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.15s ease;
    z-index: 10;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .dock-icon-label::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: rgba(50, 50, 55, 0.95);
  }

  /* Magnification Effect - using CSS :has() */
  .dock-icon:hover .dock-icon-wrapper {
    width: 64px;
    height: 64px;
    margin-bottom: 8px;
  }

  .dock-icon:hover .dock-icon-label {
    opacity: 1;
  }

  /* Adjacent icons (immediate neighbors) */
  .dock-icon:has(+ .dock-icon:hover) .dock-icon-wrapper,
  .dock-icon:hover + .dock-icon .dock-icon-wrapper {
    width: 56px;
    height: 56px;
    margin-bottom: 4px;
  }

  /* Two icons away */
  .dock-icon:has(+ .dock-icon + .dock-icon:hover) .dock-icon-wrapper,
  .dock-icon:hover + .dock-icon + .dock-icon .dock-icon-wrapper {
    width: 52px;
    height: 52px;
    margin-bottom: 2px;
  }

  .dock-icon:active .dock-icon-wrapper {
    transform: scale(0.92);
  }

  .dock-icon:focus-visible {
    outline: 2px solid rgba(10, 132, 255, 0.8);
    outline-offset: 4px;
    border-radius: 12px;
  }

  /* Active indicator (dot below icon) */
  .dock-icon[data-active="true"]::before {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 4px;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 50%;
  }

  .dock-separator {
    width: 1px;
    height: 42px;
    background: rgba(0, 0, 0, 0.12);
    margin: 0 4px 3px 4px;
    align-self: center;
  }

  /* Blinking cursor animation for terminal icon */
  @keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
  }

  .cursor-blink {
    animation: blink 1s step-end infinite;
  }

  /* Hide on mobile */
  @media (max-width: 1023px) {
    .dock-container {
      display: none;
    }
  }

  /* Accessibility: Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .dock-icon,
    .dock-icon-wrapper {
      transition: none;
    }

    .dock-icon:hover .dock-icon-wrapper {
      width: 56px;
      height: 56px;
      margin-bottom: 4px;
    }

    .dock-icon:has(+ .dock-icon:hover) .dock-icon-wrapper,
    .dock-icon:hover + .dock-icon .dock-icon-wrapper,
    .dock-icon:has(+ .dock-icon + .dock-icon:hover) .dock-icon-wrapper,
    .dock-icon:hover + .dock-icon + .dock-icon .dock-icon-wrapper {
      width: 48px;
      height: 48px;
      margin-bottom: 0;
    }

    .cursor-blink {
      animation: none;
    }
  }
</style>

<script>
  import { toggleView } from '@/scripts/view-toggle';

  function setupDock() {
    const dockIcons = document.querySelectorAll('.dock-icon');

    dockIcons.forEach((icon) => {
      icon.addEventListener('click', () => {
        const action = icon.getAttribute('data-action');

        switch (action) {
          case 'home':
            // Dispatch event to navigate to desktop root
            document.dispatchEvent(new CustomEvent('dock:navigate-home'));
            break;

          case 'posts':
            // Navigate to posts view (same as home for now)
            document.dispatchEvent(new CustomEvent('dock:navigate-home'));
            break;

          case 'series':
            // Navigate to series view (show only folders)
            document.dispatchEvent(new CustomEvent('dock:navigate-home'));
            break;

          case 'terminal':
            // Switch to terminal view using the view toggle system
            toggleView();
            break;
        }
      });
    });

    // Handle keyboard shortcut (Ctrl+Shift+D)
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        e.preventDefault();
        toggleView();
      }
    });

    // Update active state based on current path
    function updateActiveState() {
      // This will be implemented when we wire up navigation
      // For now, mark home as active if we're at root
    }

    updateActiveState();
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupDock);
  } else {
    setupDock();
  }

  // Re-initialize on Astro page loads
  document.addEventListener('astro:page-load', setupDock);
</script>
