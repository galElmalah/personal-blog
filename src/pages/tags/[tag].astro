---
import BaseLayout from "@layouts/BaseLayout.astro";
import TerminalShell from "@components/terminal/TerminalShell.astro";
import CommandLine from "@components/terminal/CommandLine.astro";
import TerminalPrompt from "@components/terminal/TerminalPrompt.astro";
import TerminalInput from "@components/terminal/TerminalInput.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("posts", ({ data }) => !data.draft);

  // Get all unique tags
  const tags = new Set<string>();
  posts.forEach((post) => {
    post.data.tags.forEach((tag) => tags.add(tag));
  });

  return [...tags].map((tag) => ({
    params: { tag: tag.toLowerCase().replace(/\s+/g, "-") },
    props: {
      tag,
      posts: posts
        .filter((post) =>
          post.data.tags.some(
            (t) =>
              t.toLowerCase().replace(/\s+/g, "-") ===
              tag.toLowerCase().replace(/\s+/g, "-"),
          ),
        )
        .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf()),
    },
  }));
}

const { tag, posts } = Astro.props;

// Format date like ls -la
function formatDate(date: Date): string {
  const months = [
    "Jan",
    "Feb",
    "Mar",
    "Apr",
    "May",
    "Jun",
    "Jul",
    "Aug",
    "Sep",
    "Oct",
    "Nov",
    "Dec",
  ];
  const day = date.getDate().toString().padStart(2, " ");
  const month = months[date.getMonth()];
  const year = date.getFullYear();
  return `${month} ${day} ${year}`;
}

// Format filename from title
function formatFilename(title: string): string {
  return (
    title
      .toLowerCase()
      .replace(/[^a-z0-9\s-]/g, "")
      .replace(/\s+/g, "-")
      .slice(0, 45) + ".md"
  );
}
---

<BaseLayout title={`Posts tagged "${tag}"`} terminalMode={true}>
  <TerminalShell>
    <!-- Back navigation -->
    <div class="mb-4 flex items-center">
      <TerminalPrompt path="~/blog" />
      <a href="/tags" class="term-link ml-2">cd tags/</a>
    </div>

    <CommandLine command="grep" args={`-l "${tag}" posts/*.md`} path="~/blog">
      <div class="term-grep">
        <div class="text-term-fg-dark text-sm mb-2">
          {posts.length} file{posts.length !== 1 ? "s" : ""} matching tag: <span
            class="text-term-green">#{tag}</span
          >
        </div>

        <div class="space-y-1 font-mono mt-4">
          {
            posts.map((post) => (
              <div class="term-grep-match">
                <span class="text-term-purple">posts/</span>
                <a
                  href={`/posts/${post.slug}`}
                  class="text-term-cyan hover:text-term-blue transition-colors"
                >
                  {formatFilename(post.data.title)}
                </a>
              </div>
            ))
          }
        </div>
      </div>
    </CommandLine>

    <!-- Detailed view with previews -->
    <div class="mt-8 border-t border-term-fg-dark/30 pt-6">
      <div class="text-term-comment text-sm mb-4">
        # grep -A3 "{tag}" posts/*.md
      </div>

      {
        posts.map((post) => (
          <div class="border border-term-fg-dark/30 rounded p-4 mb-4 bg-term-bg-alt/30">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-term-purple">posts/</span>
              <a
                href={`/posts/${post.slug}`}
                class="text-term-cyan hover:text-term-blue font-medium transition-colors"
              >
                {formatFilename(post.data.title)}
              </a>
            </div>

            <div class="pl-4 border-l-2 border-term-fg-dark/30">
              <a
                href={`/posts/${post.slug}`}
                class="block hover:text-term-cyan transition-colors"
              >
                <div class="text-term-fg font-medium mb-1">
                  {post.data.title}
                </div>
                {post.data.description && (
                  <p class="text-term-fg-dark text-sm mb-2">
                    {post.data.description}
                  </p>
                )}
              </a>
              <div class="flex flex-wrap items-center gap-3 text-xs text-term-fg-dark">
                <span class="text-term-yellow">
                  {formatDate(post.data.date)}
                </span>
                {post.data.series && (
                  <>
                    <span>|</span>
                    <a
                      href={`/series/${post.data.series.toLowerCase().replace(/\s+/g, "-")}`}
                      class="text-term-purple hover:text-term-cyan transition-colors"
                    >
                      {post.data.series}
                    </a>
                  </>
                )}
              </div>
              {post.data.tags.length > 0 && (
                <div class="flex flex-wrap gap-2 mt-2">
                  {post.data.tags.map((t) => (
                    <a
                      href={`/tags/${t.toLowerCase().replace(/\s+/g, "-")}`}
                      class:list={[
                        "text-xs transition-colors",
                        t === tag
                          ? "text-term-green"
                          : "text-term-fg-dark hover:text-term-cyan",
                      ]}
                    >
                      #{t}
                    </a>
                  ))}
                </div>
              )}
            </div>
          </div>
        ))
      }
    </div>

    <!-- Active prompt with typeable input -->
    <TerminalInput path="~/blog/tags" />
  </TerminalShell>
</BaseLayout>
