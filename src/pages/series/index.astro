---
import BaseLayout from "@layouts/BaseLayout.astro";
import TerminalShell from "@components/terminal/TerminalShell.astro";
import TerminalContext from "@components/terminal/TerminalContext.astro";
import CommandLine from "@components/terminal/CommandLine.astro";
import InteractiveTerminal from "@components/terminal/InteractiveTerminal.astro";
import { getCollection } from "astro:content";

const posts = await getCollection("posts", ({ data }) => !data.draft);

// Get all unique series with their posts
const seriesMap = new Map<string, typeof posts>();
posts.forEach((post) => {
  if (post.data.series) {
    const existing = seriesMap.get(post.data.series) || [];
    existing.push(post);
    seriesMap.set(post.data.series, existing);
  }
});

// Sort series by post count (descending), then alphabetically
const sortedSeries = [...seriesMap.entries()]
  .sort((a, b) => {
    if (b[1].length !== a[1].length) return b[1].length - a[1].length;
    return a[0].localeCompare(b[0]);
  });

// Count totals
const totalDirs = seriesMap.size;
const totalFiles = [...seriesMap.values()].reduce((acc, posts) => acc + posts.length, 0);

// Get slug from series name
function seriesSlug(series: string): string {
  return series.toLowerCase().replace(/\s+/g, '-');
}

// Format filename from title
function formatFilename(title: string): string {
  return title
    .toLowerCase()
    .replace(/[^a-z0-9\s-]/g, '')
    .replace(/\s+/g, '-')
    .slice(0, 40) + '.md';
}
---

<BaseLayout title="Series" terminalMode={true}>
  <!-- Inject posts data for terminal engine -->
  <TerminalContext currentPath="~/series" />
  
  <TerminalShell>
    <!-- SSR initial content showing tree output -->
    <CommandLine command="tree" args="series/" path="~">
      <div class="term-tree">
        <div class="term-tree-root text-term-blue font-medium">.</div>
        
        {sortedSeries.map(([series, seriesPosts], seriesIdx) => {
          const isLastSeries = seriesIdx === sortedSeries.length - 1;
          const branchChar = isLastSeries ? '└── ' : '├── ';
          const continueChar = isLastSeries ? '    ' : '│   ';
          
          // Sort posts chronologically within series
          const orderedPosts = [...seriesPosts].sort((a, b) => 
            a.data.date.valueOf() - b.data.date.valueOf()
          );
          
          return (
            <div class="term-tree-group">
              <div>
                <span class="term-tree-branch">{branchChar}</span>
                <a 
                  href={`/series/${seriesSlug(series)}`}
                  class="term-tree-dir hover:text-term-cyan transition-colors"
                >
                  {series}/
                </a>
                <span class="text-term-fg-dark text-sm ml-2">({seriesPosts.length} posts)</span>
              </div>
              {orderedPosts.map((post, postIdx) => {
                const isLastPost = postIdx === orderedPosts.length - 1;
                const postBranch = isLastPost ? '└── ' : '├── ';
                return (
                  <div>
                    <span class="term-tree-branch">{continueChar}{postBranch}</span>
                    <a 
                      href={`/posts/${post.slug}`} 
                      class="term-tree-file"
                    >
                      {formatFilename(post.data.title)}
                    </a>
                  </div>
                );
              })}
            </div>
          );
        })}
        
        <div class="term-tree-summary text-term-fg-dark mt-4 text-sm">
          {totalDirs} directories, {totalFiles} files
        </div>
      </div>
    </CommandLine>
    
    <!-- Interactive terminal with full command support -->
    <InteractiveTerminal path="~/series" runInitialLs={false} />
  </TerminalShell>
</BaseLayout>
